<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment with Proctoring - LTIMindtree</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8B5A3C;
            --secondary-color: #5A3A2B;
            --accent-color: #D4AF37;
            --bg-color: #F5F1EB;
            --text-color: #2C2C2C;
        }

        body {
            background: linear-gradient(135deg, var(--bg-color) 0%, #E8E0D5 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .btn-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 90, 60, 0.3);
            color: white;
        }

        .proctoring-status {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
        }

        .quiz-interface {
            display: none;
        }

        .question-card {
            border-left: 4px solid var(--accent-color);
        }

        .option-btn {
            border: 2px solid #dee2e6;
            background: white;
            color: var(--text-color);
            margin: 0.25rem 0;
            padding: 0.75rem 1rem;
            text-align: left;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .option-btn.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background: #e9ecef;
        }

        .progress-bar-custom {
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 10px;
        }

        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .violation-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            min-width: 400px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2><i class="fas fa-graduation-cap me-2"></i>LTIMindtree Assessment</h2>
                </div>
                <div class="col-md-6 text-end">
                    <span id="currentTime" class="me-3"></span>
                    <span id="timer" class="timer"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Proctoring Status Panel -->
    <div id="proctoringStatus" class="proctoring-status">
        <!-- Status will be injected here by proctoring system -->
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="card">
            <div class="card-body text-center p-5">
                <i class="fas fa-user-shield fa-4x text-primary mb-4"></i>
                <h3 class="mb-4">Secure Assessment Environment</h3>
                <p class="lead mb-4">
                    This assessment is monitored for integrity. Please read the instructions carefully 
                    and ensure you're in a quiet, well-lit environment.
                </p>
                
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8">
                        <div class="list-group">
                            <div class="list-group-item">
                                <i class="fas fa-eye text-success me-2"></i>
                                <strong>Camera Monitoring:</strong> Your face will be tracked during the assessment
                            </div>
                            <div class="list-group-item">
                                <i class="fas fa-microphone text-info me-2"></i>
                                <strong>Audio Monitoring:</strong> Background noise will be detected
                            </div>
                            <div class="list-group-item">
                                <i class="fas fa-window-restore text-warning me-2"></i>
                                <strong>Tab Switching:</strong> Leaving this tab will be flagged
                            </div>
                            <div class="list-group-item">
                                <i class="fas fa-expand text-primary me-2"></i>
                                <strong>Full Screen:</strong> Required for the entire assessment
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5>Student Information</h5>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <input type="text" id="studentName" class="form-control mb-3" placeholder="Enter your full name" required>
                            <input type="email" id="studentEmail" class="form-control mb-3" placeholder="Enter your email" required>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5>Assessment Options</h5>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="randomizeQuestions" checked>
                                                <label class="form-check-label" for="randomizeQuestions">
                                                    <i class="fas fa-random me-2"></i>Randomize Question Order
                                                </label>
                                                <small class="form-text text-muted d-block">Questions will be presented in random order</small>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="randomizeOptions" checked>
                                                <label class="form-check-label" for="randomizeOptions">
                                                    <i class="fas fa-shuffle me-2"></i>Randomize Answer Options
                                                </label>
                                                <small class="form-text text-muted d-block">Answer choices will be shuffled for each question</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="questionLimit" class="form-label">
                                                    <i class="fas fa-list-ol me-2"></i>Number of Questions
                                                </label>
                                                <select class="form-select" id="questionLimit">
                                                    <option value="">All Available Questions</option>
                                                    <option value="3">3 Questions</option>
                                                    <option value="5" selected>5 Questions</option>
                                                    <option value="10">10 Questions</option>
                                                    <option value="15">15 Questions</option>
                                                    <option value="20">20 Questions</option>
                                                </select>
                                                <small class="form-text text-muted">Limit the number of questions randomly selected</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5>Select Proctoring Level</h5>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="proctoringLevel" id="basicLevel" value="basic" checked>
                                <label class="btn btn-outline-primary" for="basicLevel">
                                    <i class="fas fa-shield-alt me-2"></i>Basic Monitoring
                                </label>
                                
                                <input type="radio" class="btn-check" name="proctoringLevel" id="standardLevel" value="standard">
                                <label class="btn btn-outline-primary" for="standardLevel">
                                    <i class="fas fa-shield me-2"></i>Standard Monitoring
                                </label>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                Standard monitoring includes face detection and stricter violation tracking
                            </small>
                        </div>
                    </div>
                </div>

                <button class="btn btn-custom btn-lg" onclick="startAssessment()">
                    <i class="fas fa-play me-2"></i>Start Proctored Assessment
                </button>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="quizInterface" class="quiz-interface">
            <!-- Progress Bar -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Progress</span>
                                <span id="progressText">0 / 0</span>
                            </div>
                            <div class="progress progress-custom">
                                <div id="progressBar" class="progress-bar progress-bar-custom" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div id="timeRemaining" class="timer">30:00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Card -->
            <div class="card question-card">
                <div class="card-header">
                    <h5 id="questionTitle" class="mb-0">Question 1 of 10</h5>
                </div>
                <div class="card-body">
                    <h6 id="questionText" class="mb-4">Loading question...</h6>
                    <div id="optionsContainer">
                        <!-- Options will be loaded here -->
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-6">
                            <button id="prevBtn" class="btn btn-outline-secondary" onclick="previousQuestion()" disabled>
                                <i class="fas fa-chevron-left me-2"></i>Previous
                            </button>
                        </div>
                        <div class="col-6 text-end">
                            <button id="nextBtn" class="btn btn-custom" onclick="nextQuestion()">
                                Next<i class="fas fa-chevron-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Card -->
            <div id="submitCard" class="card mt-3" style="display: none;">
                <div class="card-body text-center">
                    <h5>Ready to Submit?</h5>
                    <p class="text-muted">Please review your answers before final submission.</p>
                    <button class="btn btn-success btn-lg" onclick="submitAssessment()">
                        <i class="fas fa-check me-2"></i>Submit Assessment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Violation Alert Modal -->
    <div id="violationAlert" class="violation-alert alert alert-danger" style="display: none;">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Proctoring Violation Detected</h5>
        <p id="violationMessage">Please return focus to the assessment.</p>
        <button class="btn btn-sm btn-outline-danger" onclick="dismissViolation()">Understood</button>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Assessment Configuration
        const ASSESSMENT_CONFIG = {
            assessmentId: 'demo-assessment-001',
            duration: 30 * 60 * 1000, // 30 minutes
            questions: [
                {
                    id: 1,
                    text: "What is the primary purpose of machine learning in artificial intelligence?",
                    options: [
                        "To replace human intelligence completely",
                        "To enable computers to learn and improve from data without explicit programming",
                        "To create robots that look like humans",
                        "To store large amounts of data efficiently"
                    ],
                    correct: 1
                },
                {
                    id: 2,
                    text: "Which programming language is most commonly used for web development?",
                    options: [
                        "Python",
                        "Java",
                        "JavaScript",
                        "C++"
                    ],
                    correct: 2
                },
                {
                    id: 3,
                    text: "What does API stand for in software development?",
                    options: [
                        "Application Programming Interface",
                        "Advanced Programming Instructions",
                        "Automated Program Integration",
                        "Application Performance Indicator"
                    ],
                    correct: 0
                },
                {
                    id: 4,
                    text: "Which of the following is a NoSQL database?",
                    options: [
                        "MySQL",
                        "PostgreSQL",
                        "MongoDB",
                        "SQLite"
                    ],
                    correct: 2
                },
                {
                    id: 5,
                    text: "What is the purpose of version control systems like Git?",
                    options: [
                        "To compress files",
                        "To track changes in code and collaborate with others",
                        "To run automated tests",
                        "To deploy applications to production"
                    ],
                    correct: 1
                }
            ]
        };

        // Assessment State
        let currentQuestionIndex = 0;
        let answers = {};
        let startTime = null;
        let timer = null;
        let proctoringSystem = null;
        let sessionId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        async function startAssessment() {
            const studentName = document.getElementById('studentName').value.trim();
            const studentEmail = document.getElementById('studentEmail').value.trim();
            const proctoringLevel = document.querySelector('input[name="proctoringLevel"]:checked').value;
            
            // Get randomization options
            const randomizeQuestions = document.getElementById('randomizeQuestions').checked;
            const randomizeOptions = document.getElementById('randomizeOptions').checked;
            const questionLimit = document.getElementById('questionLimit').value;

            if (!studentName || !studentEmail) {
                alert('Please enter your name and email before starting.');
                return;
            }

            try {
                // Initialize proctoring system
                sessionId = generateSessionId();
                
                // Load quiz with randomization options
                await loadRandomizedQuiz(randomizeQuestions, randomizeOptions, questionLimit);
                
                // Start proctoring (this would typically load from proctoring.html)
                await initializeProctoringSystem(proctoringLevel, studentName, studentEmail);
                
                // Hide welcome screen and show quiz
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('quizInterface').style.display = 'block';
                
                // Start timer
                startTime = Date.now();
                startTimer();
                
                // Load first question
                loadQuestion(0);
                
                console.log('Assessment started with options:', {
                    proctoringLevel,
                    randomizeQuestions,
                    randomizeOptions,
                    questionLimit
                });
            } catch (error) {
                console.error('Failed to start assessment:', error);
                alert('Failed to initialize assessment. Please check your settings and try again.');
            }
        }

        async function loadRandomizedQuiz(randomizeQuestions, randomizeOptions, questionLimit) {
            try {
                const params = new URLSearchParams({
                    session_id: sessionId,
                    randomize_questions: randomizeQuestions.toString(),
                    randomize_options: randomizeOptions.toString()
                });
                
                if (questionLimit) {
                    params.append('question_limit', questionLimit);
                }
                
                // For demo, we'll use the hardcoded questions with client-side randomization
                let questions = [...ASSESSMENT_CONFIG.questions];
                
                // Apply client-side randomization to match server behavior
                if (randomizeOptions) {
                    questions = questions.map(question => randomizeQuestionOptions(question));
                }
                
                if (randomizeQuestions) {
                    questions = shuffleArray(questions);
                }
                
                if (questionLimit && questionLimit > 0) {
                    questions = questions.slice(0, parseInt(questionLimit));
                }
                
                // Update the config with randomized questions
                ASSESSMENT_CONFIG.questions = questions;
                
                console.log(`Quiz loaded with ${questions.length} randomized questions`);
                
                // Log randomization to proctoring system
                await logRandomizationEvent({
                    randomizeQuestions,
                    randomizeOptions,
                    questionLimit: questionLimit || null,
                    originalCount: 5, // Original demo has 5 questions
                    finalCount: questions.length
                });
                
            } catch (error) {
                console.error('Failed to load randomized quiz:', error);
                throw error;
            }
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function randomizeQuestionOptions(question) {
            const correctAnswer = question.options[question.correct];
            const shuffledOptions = shuffleArray(question.options);
            const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);

            return {
                ...question,
                options: shuffledOptions,
                correct: newCorrectIndex,
                originalOrder: question.options
            };
        }

        async function logRandomizationEvent(randomizationData) {
            try {
                await fetch('/api/proctoring/log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        event: 'quiz_randomization',
                        randomization: {
                            ...randomizationData,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
            } catch (error) {
                console.error('Failed to log randomization event:', error);
            }
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function initializeProctoringSystem(level, name, email) {
            // This would normally load the proctoring system from proctoring.html
            // For this demo, we'll simulate the initialization
            
            try {
                // Simulate API call to start proctoring session
                const response = await fetch('/api/proctoring/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        userEmail: email,
                        userName: name,
                        assessmentId: ASSESSMENT_CONFIG.assessmentId,
                        proctoringLevel: level,
                        browserInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        },
                        systemInfo: {
                            screen: {
                                width: screen.width,
                                height: screen.height
                            },
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to start proctoring session');
                }

                // Show proctoring status
                showProctoringStatus(level);
                
                // Set up basic violation detection
                setupBasicViolationDetection();
                
            } catch (error) {
                console.error('Proctoring initialization failed:', error);
                throw error;
            }
        }

        function showProctoringStatus(level) {
            const statusPanel = document.getElementById('proctoringStatus');
            statusPanel.innerHTML = `
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <small><i class="fas fa-shield-alt me-2"></i>Proctoring Active (${level.toUpperCase()})</small>
                    </div>
                    <div class="card-body p-2">
                        <div class="small">
                            <div><i class="fas fa-eye text-success me-2"></i>Camera: Active</div>
                            <div><i class="fas fa-microphone text-success me-2"></i>Audio: Monitoring</div>
                            <div><i class="fas fa-window-restore text-success me-2"></i>Tab: Focused</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupBasicViolationDetection() {
            // Tab/Window visibility detection
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    logViolation('tab_switch', 'medium', 'User switched to another tab or window');
                    showViolationAlert('Please return to the assessment tab. Tab switching has been detected.');
                }
            });

            // Window focus detection
            window.addEventListener('blur', function() {
                logViolation('window_focus', 'medium', 'Window lost focus');
            });

            // Right-click prevention
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                logViolation('right_click', 'low', 'Right-click attempted');
                showViolationAlert('Right-click is disabled during the assessment.');
            });

            // Keyboard shortcuts prevention
            document.addEventListener('keydown', function(e) {
                // Prevent F12, Ctrl+Shift+I, Ctrl+U, etc.
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                    (e.ctrlKey && e.key === 'u')) {
                    e.preventDefault();
                    logViolation('dev_tools', 'high', 'Attempted to open developer tools');
                    showViolationAlert('Developer tools access is restricted during the assessment.');
                }
            });
        }

        async function logViolation(type, severity, description) {
            try {
                await fetch('/api/proctoring/log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        event: 'violation',
                        violation: {
                            description: description,
                            severity: severity,
                            metadata: {
                                type: type,
                                timestamp: new Date().toISOString(),
                                questionIndex: currentQuestionIndex
                            }
                        }
                    })
                });
            } catch (error) {
                console.error('Failed to log violation:', error);
            }
        }

        function showViolationAlert(message) {
            const alert = document.getElementById('violationAlert');
            document.getElementById('violationMessage').textContent = message;
            alert.style.display = 'block';
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                dismissViolation();
            }, 5000);
        }

        function dismissViolation() {
            document.getElementById('violationAlert').style.display = 'none';
        }

        function startTimer() {
            const endTime = startTime + ASSESSMENT_CONFIG.duration;
            
            timer = setInterval(() => {
                const now = Date.now();
                const timeLeft = endTime - now;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitAssessment(true); // Auto-submit
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById('timeRemaining').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function loadQuestion(index) {
            const question = ASSESSMENT_CONFIG.questions[index];
            if (!question) return;

            currentQuestionIndex = index;
            
            // Update question display
            document.getElementById('questionTitle').textContent = `Question ${index + 1} of ${ASSESSMENT_CONFIG.questions.length}`;
            document.getElementById('questionText').textContent = question.text;
            
            // Update progress
            const progress = ((index + 1) / ASSESSMENT_CONFIG.questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${index + 1} / ${ASSESSMENT_CONFIG.questions.length}`;
            
            // Load options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, i) => {
                const button = document.createElement('button');
                button.className = 'btn option-btn w-100';
                button.textContent = `${String.fromCharCode(65 + i)}. ${option}`;
                button.onclick = () => selectOption(i);
                
                if (answers[question.id] === i) {
                    button.classList.add('selected');
                }
                
                optionsContainer.appendChild(button);
            });
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').textContent = 
                index === ASSESSMENT_CONFIG.questions.length - 1 ? 'Finish' : 'Next';
            
            // Show submit card on last question
            const submitCard = document.getElementById('submitCard');
            if (index === ASSESSMENT_CONFIG.questions.length - 1) {
                submitCard.style.display = 'block';
            } else {
                submitCard.style.display = 'none';
            }
        }

        function selectOption(optionIndex) {
            const question = ASSESSMENT_CONFIG.questions[currentQuestionIndex];
            answers[question.id] = optionIndex;
            
            // Update button styles
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, i) => {
                btn.classList.toggle('selected', i === optionIndex);
            });
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < ASSESSMENT_CONFIG.questions.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                submitAssessment();
            }
        }

        async function submitAssessment(autoSubmit = false) {
            if (!autoSubmit) {
                const confirmed = confirm('Are you sure you want to submit your assessment? This action cannot be undone.');
                if (!confirmed) return;
            }
            
            try {
                // Stop timer
                if (timer) {
                    clearInterval(timer);
                }
                
                // Calculate score
                let correctAnswers = 0;
                ASSESSMENT_CONFIG.questions.forEach(question => {
                    if (answers[question.id] === question.correct) {
                        correctAnswers++;
                    }
                });
                
                const score = Math.round((correctAnswers / ASSESSMENT_CONFIG.questions.length) * 100);
                const duration = Date.now() - startTime;
                
                // End proctoring session
                await fetch('/api/proctoring/end', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        completionTime: new Date().toISOString(),
                        score: score,
                        totalQuestions: ASSESSMENT_CONFIG.questions.length,
                        correctAnswers: correctAnswers
                    })
                });
                
                // Submit results to main API
                await fetch('/api/results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_name: document.getElementById('studentName').value,
                        student_email: document.getElementById('studentEmail').value,
                        quiz_name: 'Demo Assessment',
                        score: score,
                        total_questions: ASSESSMENT_CONFIG.questions.length,
                        correct_answers: correctAnswers,
                        duration_minutes: Math.round(duration / 60000),
                        proctoring_session_id: sessionId
                    })
                });
                
                // Show results
                showResults(score, correctAnswers);
                
            } catch (error) {
                console.error('Failed to submit assessment:', error);
                alert('Failed to submit assessment. Please try again.');
            }
        }

        function showResults(score, correctAnswers) {
            const quizInterface = document.getElementById('quizInterface');
            quizInterface.innerHTML = `
                <div class="card text-center">
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <i class="fas fa-trophy fa-4x text-warning"></i>
                        </div>
                        <h2 class="mb-3">Assessment Completed!</h2>
                        <div class="row justify-content-center mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h1 class="display-4 text-primary">${score}%</h1>
                                        <p class="lead">Your Score</p>
                                        <p class="mb-0">${correctAnswers} out of ${ASSESSMENT_CONFIG.questions.length} questions correct</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted">
                            Your assessment has been submitted successfully with proctoring data.
                            Results will be reviewed and finalized shortly.
                        </p>
                        <button class="btn btn-custom" onclick="window.close()">
                            <i class="fas fa-check me-2"></i>Close Assessment
                        </button>
                    </div>
                </div>
            `;
            
            // Hide proctoring status
            document.getElementById('proctoringStatus').style.display = 'none';
        }
    </script>
</body>
</html>
